<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Mis reservas - AereoSky</title>

    <!-- Igual que home.html -->
    <script src="/services/auth.js" defer></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      }
      .badge {
        border-radius: 9999px;
        font-size: 0.75rem;
        padding: 0.125rem 0.5rem;
        font-weight: 600;
      }
    </style>
  </head>

  <body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">
    <!-- NAVBAR (copiado de home.html) -->
    <nav class="bg-white shadow-lg fixed w-full z-10">
      <div class="container mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <svg
              class="h-8 w-8 text-blue-600 mr-2"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
            <a
              href="../../index.html"
              class="text-2xl font-bold text-gray-800"
              >AereoSky</a
            >
          </div>

          <div class="hidden md:flex items-center space-x-6">
            <a
              href="../../index.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Home</a
            >
            <a
              href="/views/consulta-vuelos.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Vuelos</a
            >

            <!-- Mis Reservas (visible solo si está logueado) -->
            <a
              href="/views/mis-reservas.html"
              id="nav-mis-reservas"
              class="hidden text-gray-600 hover:text-blue-600 transition duration-300"
              >Mis Reservas</a
            >

            <a
              href="/views/contacto.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Contacto</a
            >

            <div id="admin-panel" class="hidden relative">
              <button
                id="admin-panel-button"
                class="flex items-center text-gray-600 font-semibold hover:text-blue-600 p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition"
              >
                <span>Administración</span>
                <svg
                  class="h-5 w-5 ml-1"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <div
                id="admin-panel-menu"
                class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-20"
              >
                <a
                  href="/views/aviones.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Aviones</a
                >
                <a
                  href="/views/aerolineas.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Aerolineas</a
                >
                <a
                  href="/views/fabricantes.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Fabricantes</a
                >
                <a
                  href="/views/usuarios.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Usuarios</a
                >
                <a
                  href="/views/reservas.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Reservas</a
                >
              </div>
            </div>
          </div>

          <a
            href="/views/login.html"
            id="login-button"
            class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 shadow"
          >
            Iniciar Sesión
          </a>

          <div id="user-menu" class="hidden items-center space-x-4">
            <a
              href="/views/perfil.html"
              class="text-gray-600 hover:text-blue-600 font-medium"
              >Mi Perfil</a
            >
            <button
              id="logout-button"
              class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition duration-300 shadow"
            >
              Cerrar Sesión
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- CONTENIDO -->
    <main class="pt-24 pb-16 container mx-auto px-6 max-w-6xl flex-1">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold">Mis reservas</h1>
          <p class="text-sm text-gray-500">
            Administra tus reservas: paga, cancela o solicita reenvío de
            documentos.
          </p>
        </div>
        <div class="text-xs text-gray-500" id="mini-session"></div>
      </div>

      <!-- Filtros locales -->
      <div class="bg-white rounded-xl shadow p-4 mb-6">
        <div
          class="flex flex-col md:flex-row md:items-end md:justify-between gap-4"
        >
          <div class="flex items-center gap-2">
            <button
              data-scope="all"
              class="tab-scope bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold"
            >
              Todas
            </button>
            <button
              data-scope="Pendiente"
              class="tab-scope bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200"
            >
              Pendientes
            </button>
            <button
              data-scope="Confirmada"
              class="tab-scope bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200"
            >
              Confirmadas
            </button>
            <button
              data-scope="Cancelada"
              class="tab-scope bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200"
            >
              Canceladas
            </button>
          </div>

          <div class="flex items-center gap-3">
            <input
              id="txtBuscar"
              type="text"
              placeholder="Buscar por ruta, aerolínea o #reserva"
              class="w-64 border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <select
              id="ordenResultados"
              class="border border-gray-300 rounded-md px-2 py-2"
            >
              <option value="recientes">Más recientes</option>
              <option value="antiguas">Más antiguas</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Contador -->
      <div class="flex items-center justify-between mb-2">
        <div class="text-sm text-gray-500" id="lblResumenLista"></div>
        <div class="text-sm text-gray-500" id="lblErrores"></div>
      </div>

      <!-- Lista -->
      <div id="listaReservas" class="grid gap-4">
        <!-- tarjetas dinámicas -->
      </div>
    </main>

    <!-- FOOTER (copiado de home.html) -->
    <footer class="bg-gray-800 text-white py-10">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h4 class="text-lg font-semibold mb-4">AereoSky</h4>
            <p class="text-gray-400">
              Tu compañero de viaje ideal. Hacemos que la reserva de vuelos sea
              simple, rápida y asequible.
            </p>
          </div>

          <div>
            <h4 class="text-lg font-semibold mb-4">Enlaces Rápidos</h4>
            <ul class="space-y-2 text-gray-400" id="footer-links">
              <li>
                <a href="../../index.html" class="hover:text-white">Home</a>
              </li>
              <li>
                <a
                  href="/views/consulta-vuelos.html"
                  class="hover:text-white"
                  >Vuelos</a
                >
              </li>
              <!-- Mis Reservas (solo autenticado) -->
              <li id="footer-mis-reservas" class="hidden">
                <a href="/views/mis-reservas.html" class="hover:text-white"
                  >Mis Reservas</a
                >
              </li>
              <li>
                <a href="/views/contacto.html" class="hover:text-white"
                  >Contacto</a
                >
              </li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg font-semibold mb-4">Contacto</h4>
            <ul class="space-y-2 text-gray-400">
              <li>Email: soporte@AereoSky.com</li>
              <li>Teléfono: +593 985 514 590</li>
              <li>Dirección: Machala, Ecuador</li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg font-semibold mb-4">Síguenos</h4>
            <div class="flex space-x-4">
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.28C8.28,9.09 5.11,7.38 2.9,4.79C2.53,5.42 2.33,6.16 2.33,6.94C2.33,8.43 3.08,9.75 4.18,10.53C3.49,10.51 2.82,10.31 2.22,10V10.06C2.22,12.23 3.78,14.05 5.9,14.45C5.55,14.54 5.18,14.59 4.8,14.59C4.54,14.59 4.28,14.56 4.03,14.51C4.6,16.28 6.26,17.56 8.24,17.6C6.68,18.81 4.77,19.53 2.72,19.53C2.38,19.53 2.05,19.51 1.72,19.46C3.72,20.78 6.11,21.56 8.75,21.56C16.01,21.56 20.24,15.71 20.24,10.65C20.24,10.46 20.24,10.27 20.23,10.08C21.02,9.49 21.8,8.78 22.46,7.92V6Z"
                  /></svg
              ></a>
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.32 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96C18.34 21.21 22 17.06 22 12.06C22 6.53 17.5 2.04 12 2.04Z"
                  /></svg
              ></a>
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7Z"
                  /></svg
              ></a>
            </div>
          </div>
        </div>

        <div
          class="mt-8 border-t border-gray-700 pt-6 text-center text-gray-500"
        >
          <p>&copy; 2025 AereoSky. Todos los derechos reservados.</p>
        </div>
      </div>
    </footer>

    <!-- SCRIPT PRINCIPAL DE LA PÁGINA -->
    <script>
      // -------- utilidades ----------
      function onlyDigits(s) {
        return String(s || "").replace(/\D/g, "");
      }

      function formatDateTime(raw) {
        if (!raw) {
          return { fecha: "N/D", hora: "N/D" };
        }
        var iso = String(raw).replace(" ", "T");
        var d = new Date(iso);
        if (isNaN(d.getTime())) {
          var d2 = new Date(iso + "Z");
          if (!isNaN(d2.getTime())) d = d2;
        }
        if (isNaN(d.getTime())) {
          return { fecha: String(raw), hora: "" };
        }
        return {
          fecha: d.toLocaleDateString("es-EC", {
            year: "numeric",
            month: "long",
            day: "numeric",
          }),
          hora: d.toLocaleTimeString("es-EC", {
            hour: "2-digit",
            minute: "2-digit",
          }),
        };
      }

      function badgeEstado(estado) {
        var e = (estado || "").toLowerCase();
        if (e === "pendiente")
          return '<span class="badge bg-yellow-100 text-yellow-800 border border-yellow-300">Pendiente</span>';
        if (e === "confirmada")
          return (
            '<span class="badge bg-green-100 text-green-800 border border-green-300">' +
            (estado.charAt(0).toUpperCase() + estado.slice(1)) +
            "</span>"
          );
        if (e === "cancelada")
          return '<span class="badge bg-red-100 text-red-800 border border-red-300">Cancelada</span>';
        return (
          '<span class="badge bg-gray-100 text-gray-700 border border-gray-300">' +
          (estado || "N/D") +
          "</span>"
        );
      }

      // -------- estado global ----------
      var currentUser = null;
      try {
        var raw = localStorage.getItem("currentUser");
        if (raw) currentUser = JSON.parse(raw);
      } catch (e) {}
      var miniSession = document.getElementById("mini-session");
      if (currentUser) {
        miniSession.textContent =
          "Sesión: " +
          (currentUser.correo ||
            currentUser.email ||
            "Usuario #" + currentUser.id_usuario);
      } else {
        miniSession.textContent = "No autenticado";
      }

      var listaEl = document.getElementById("listaReservas");
      var lblResumen = document.getElementById("lblResumenLista");
      var lblErrores = document.getElementById("lblErrores");
      var txtBuscar = document.getElementById("txtBuscar");
      var ordenSelect = document.getElementById("ordenResultados");
      var scopeBtns = [].slice.call(document.querySelectorAll(".tab-scope"));

      var reservasRaw = []; // como vienen del backend
      var reservasView = []; // proyectadas para la UI
      var scope = "all";

      // -------- fetch helper ----------
      async function fetchJSON(url, options) {
        try {
          var r = await fetch(url, options || {});
          var j = await r.json();
          return { ok: r.ok, data: j };
        } catch (err) {
          return { ok: false, data: { message: "Error de conexión" } };
        }
      }

      // -------- back: listar reservas del usuario ----------
      async function cargarReservasUsuario(idUsuario) {
        var try1 = await fetchJSON(
          "https://reserva-vuelos-backend.onrender.com/reservas/usuario/" + idUsuario
        );
        if (try1.ok && Array.isArray(try1.data)) return try1.data;

        var try2 = await fetchJSON(
          "https://reserva-vuelos-backend.onrender.com/usuarios/" + idUsuario + "/reservas"
        );
        if (try2.ok && Array.isArray(try2.data)) return try2.data;

        var try3 = await fetchJSON(
          "https://reserva-vuelos-backend.onrender.com/reservas?usuario=" +
            encodeURIComponent(idUsuario)
        );
        if (try3.ok && Array.isArray(try3.data)) return try3.data;

        throw new Error(
          (try1.data && try1.data.message) ||
            (try2.data && try2.data.message) ||
            (try3.data && try3.data.message) ||
            "No se pudieron obtener las reservas."
        );
      }

      // -------- back: resumen / checkout de una reserva ----------
      async function cargarResumenReserva(idReserva) {
        var r = await fetchJSON("https://reserva-vuelos-backend.onrender.com/checkout/" + idReserva);
        if (!r.ok)
          throw new Error(
            r.data && r.data.message
              ? r.data.message
              : "No se pudo cargar el detalle"
          );
        return r.data;
      }

      // -------- pintar tarjetas ----------
      function pintarLista() {
        // 1. aplicar filtro de estado (scope)
        var arr = reservasView.filter(function (x) {
          if (scope === "all") return true;
          return (
            String(x.estado || "").toLowerCase() === String(scope).toLowerCase()
          );
        });

        // 2. filtro por texto
        var q = txtBuscar.value.trim().toLowerCase();
        if (q) {
          arr = arr.filter(function (x) {
            var ruta = (x.ruta || "").toLowerCase();
            var aero = (x.aerolinea || "").toLowerCase();
            var idr = String(x.id_reserva || "");
            return (
              ruta.indexOf(q) >= 0 ||
              aero.indexOf(q) >= 0 ||
              idr.indexOf(q) >= 0
            );
          });
        }

        // 3. ordenar por fecha (recientes / antiguas)
        arr.sort(function (a, b) {
          var sa = new Date(
            a.fecha_raw || a.fecha_reserva || a.fecha_registro || 0
          ).getTime();
          var sb = new Date(
            b.fecha_raw || b.fecha_reserva || b.fecha_registro || 0
          ).getTime();
          if (ordenSelect.value === "recientes") return sb - sa;
          return sa - sb;
        });

        lblResumen.textContent = "(" + arr.length + " reservas)";

        listaEl.innerHTML = "";
        if (arr.length === 0) {
          var vacio = document.createElement("div");
          vacio.className =
            "bg-white rounded-xl shadow p-6 text-center text-gray-500";
          vacio.textContent =
            "No hay reservas para mostrar con los filtros actuales.";
          listaEl.appendChild(vacio);
          return;
        }

        arr.forEach(function (r) {
          var f = formatDateTime(
            r.fecha_reserva || r.fecha_registro || r.fecha || r.fecha_raw
          );
          var ruta = r.ruta || "Ruta no disponible";
          var aero = r.aerolinea
            ? r.aerolinea +
              (r.codigo_aerolinea ? " (" + r.codigo_aerolinea + ")" : "")
            : "Aerolínea no disponible";

          var card = document.createElement("div");
          card.className =
            "bg-white rounded-xl shadow border border-gray-200 p-5";
          card.setAttribute("data-id", String(r.id_reserva));

          var actionsHtml = "";
          var estLower = String(r.estado || "").toLowerCase();

          if (estLower === "pendiente") {
            actionsHtml +=
              '<a href="/views/compra.html?id_reserva=' +
              r.id_reserva +
              '" class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg shadow mr-2">Pagar ahora</a>' +
              '<button data-act="cancelar" class="inline-flex items-center bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg shadow">Cancelar</button>';
          } else if (estLower === "confirmada") {
            actionsHtml +=
              '<button data-act="detalles" class="inline-flex items-center bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg shadow mr-2">Ver detalles</button>' +
              '<button data-act="reenviar" class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg shadow">Reenviar correo</button>';
          } else {
            actionsHtml +=
              '<span class="text-sm text-gray-500">Sin acciones disponibles.</span>';
          }

          card.innerHTML =
            '<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">' +
            "<div>" +
            '<div class="flex items-center gap-2 text-lg font-semibold text-gray-900">' +
            "<span>#" +
            r.id_reserva +
            "</span>" +
            "<span>·</span>" +
            "<span>" +
            badgeEstado(r.estado || "") +
            "</span>" +
            "</div>" +
            '<div class="text-sm text-gray-600 mt-1">' +
            aero +
            "</div>" +
            '<div class="text-sm text-gray-700">' +
            ruta +
            "</div>" +
            '<div class="text-xs text-gray-500 mt-1">Reserva de ' +
            f.fecha +
            " · " +
            f.hora +
            "</div>" +
            "</div>" +
            '<div class="flex-shrink-0">' +
            actionsHtml +
            "</div>" +
            "</div>" +
            '<div class="mt-4 hidden detalle-box">' +
            '<div class="text-sm text-gray-700">Cargando detalles...</div>' +
            "</div>";

          // handlers de acciones
          card.addEventListener("click", async function (ev) {
            var t = ev.target;
            if (!t || !t.getAttribute) return;
            var act = t.getAttribute("data-act");
            if (!act) return;

            if (act === "cancelar") {
              ev.preventDefault();
              await cancelarReserva(r.id_reserva, card);
            }
            if (act === "detalles") {
              ev.preventDefault();
              await toggleDetalles(r.id_reserva, card);
            }
            if (act === "reenviar") {
              ev.preventDefault();
              await reenviarCorreo(r.id_reserva, card);
            }
          });

          listaEl.appendChild(card);
        });
      }

      // -------- ver detalles (expande tarjeta) ----------
      async function toggleDetalles(idReserva, cardEl) {
        var box = cardEl.querySelector(".detalle-box");
        if (!box) return;

        // si ya está visible -> colapsar
        if (!box.classList.contains("hidden")) {
          box.classList.add("hidden");
          box.innerHTML =
            '<div class="text-sm text-gray-700">Cargando detalles...</div>';
          return;
        }

        // abrir y cargar data
        box.classList.remove("hidden");
        box.innerHTML =
          '<div class="text-sm text-gray-500">Cargando detalles...</div>';

        try {
          var det = await cargarResumenReserva(idReserva);

          // formateo fechas salida/llegada
          var fs = formatDateTime(det.vuelo && det.vuelo.fecha_salida);
          var fl = formatDateTime(det.vuelo && det.vuelo.fecha_llegada);

          var html =
            '<div class="grid md:grid-cols-2 gap-4">' +
            "<div>" +
            '<div class="text-xs uppercase text-gray-500">Ruta</div>' +
            '<div class="font-medium">' +
            (det.vuelo ? det.vuelo.origen + " → " + det.vuelo.destino : "N/D") +
            "</div>" +
            '<div class="text-xs text-gray-600">Aerolínea: ' +
            (det.vuelo
              ? det.vuelo.aerolinea + " (" + det.vuelo.codigo_aerolinea + ")"
              : "N/D") +
            "</div>" +
            "</div>" +
            '<div class="grid grid-cols-2 gap-4 text-sm">' +
            "<div>" +
            '<div class="text-xs text-gray-500 uppercase">Salida</div>' +
            '<div class="font-medium">' +
            fs.fecha +
            "</div>" +
            '<div class="text-gray-800">' +
            fs.hora +
            "</div>" +
            "</div>" +
            "<div>" +
            '<div class="text-xs text-gray-500 uppercase">Llegada</div>' +
            '<div class="font-medium">' +
            fl.fecha +
            "</div>" +
            '<div class="text-gray-800">' +
            fl.hora +
            "</div>" +
            "</div>" +
            "</div>" +
            "</div>" +
            '<div class="mt-3 grid md:grid-cols-3 gap-4 text-sm">' +
            "<div>" +
            '<div class="text-xs text-gray-500 uppercase">Clase</div>' +
            '<div class="font-medium">' +
            (det.categoria ? det.categoria.nombre_categoria : "N/D") +
            "</div>" +
            "</div>" +
            "<div>" +
            '<div class="text-xs text-gray-500 uppercase">Subtotal</div>' +
            '<div class="font-medium">$ ' +
            (det.precios
              ? Number(det.precios.monto_total).toFixed(2)
              : "0.00") +
            "</div>" +
            "</div>" +
            "<div>" +
            '<div class="text-xs text-gray-500 uppercase">Total</div>' +
            '<div class="font-bold text-blue-600">$ ' +
            (det.precios
              ? Number(det.precios.total_con_impuestos).toFixed(2)
              : "0.00") +
            "</div>" +
            "</div>" +
            "</div>" +
            '<div class="mt-2 text-xs text-gray-500">Reserva #' +
            det.id_reserva +
            " · Estado " +
            (det.estado_reserva || "N/D") +
            "</div>";

          box.innerHTML = html;
        } catch (e) {
          box.innerHTML =
            '<div class="text-sm text-red-600">No se pudieron cargar los detalles: ' +
            (e.message || "Error") +
            "</div>";
        }
      }

      // pide al backend el id_compra para una reserva dada
      async function fetchIdCompraPorReserva(idReserva) {
        const resp = await fetchJSON(
          "https://reserva-vuelos-backend.onrender.com/compra/" + idReserva
        );
        if (!resp.ok) {
          throw new Error(
            resp.data && resp.data.message
              ? resp.data.message
              : "No se pudo obtener la compra asociada a la reserva."
          );
        }
        if (!resp.data || !resp.data.id_compra) {
          throw new Error("No existe compra asociada a esta reserva.");
        }
        return resp.data.id_compra;
      }

      // -------- reenviar correo (usa /correo-compra/:id_compra) ----------
      async function reenviarCorreo(idReserva, cardEl) {
        try {
          // 1. obtener el id_compra real de esta reserva
          const id_compra = await fetchIdCompraPorReserva(idReserva);

          // 2. llamar al endpoint oficial:
          //    router.post("/correo-compra/:id_compra", reenviarCorreoCompra);
          const resp = await fetchJSON(
            "https://reserva-vuelos-backend.onrender.com/correo-compra/" + id_compra,
            { method: "POST" }
          );

          if (resp.ok) {
            const msg =
              resp.data && resp.data.message
                ? resp.data.message
                : "Correo reenviado correctamente.";
            alert(msg);
          } else {
            const errMsg =
              resp.data && resp.data.message
                ? resp.data.message
                : "Error al reenviar el correo de compra.";
            alert(errMsg);
          }
        } catch (e) {
          alert("No se pudo reenviar el correo: " + (e.message || "Error"));
        }
      }

      // -------- cancelar reserva ----------
      async function cancelarReserva(idReserva, cardEl) {
        if (!confirm("¿Seguro que deseas cancelar esta reserva?")) return;

        var ok = false,
          msg = "Reserva cancelada.";

        var r1 = await fetchJSON(
          "https://reserva-vuelos-backend.onrender.com/reservas/" + idReserva + "/cancelar",
          { method: "POST" }
        );
        if (r1.ok) {
          ok = true;
          msg = (r1.data && (r1.data.message || r1.data.msg)) || msg;
        }

        if (!ok) {
          var r2 = await fetch("https://reserva-vuelos-backend.onrender.com/reservas/" + idReserva, {
            method: "DELETE",
          });
          if (r2.ok) {
            ok = true;
            msg = "Reserva cancelada.";
          }
        }

        if (!ok) {
          var r3 = await fetch("https://reserva-vuelos-backend.onrender.com/reservas/" + idReserva, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ estado: "Cancelada" }),
          });
          if (r3.ok) {
            ok = true;
            msg = "Reserva cancelada.";
          }
        }

        if (ok) {
          reservasView = reservasView.map(function (x) {
            if (Number(x.id_reserva) === Number(idReserva)) {
              x.estado = "Cancelada";
            }
            return x;
          });
          pintarLista();
          alert(msg);
        } else {
          alert("No fue posible cancelar la reserva en este momento.");
        }
      }

      // -------- mapear respuesta cruda -> UI ----------
      function proyectarReservasCrudas(arr) {
        return arr.map(function (r) {
          var estado = r.estado || r.estado_reserva || "Pendiente";

          var ruta = "";
          if (r.origen_ciudad && r.destino_ciudad) {
            ruta =
              r.origen_ciudad +
              " (" +
              (r.origen_codigo || "") +
              ") → " +
              r.destino_ciudad +
              " (" +
              (r.destino_codigo || "") +
              ")";
          } else if (r.ruta) {
            ruta = r.ruta;
          } else {
            ruta = "Ruta disponible en Detalles";
          }

          return {
            id_reserva: r.id_reserva,
            id_vuelo: r.id_vuelo,
            estado: estado,
            aerolinea: r.nombre_aerolinea || r.aerolinea || "",
            codigo_aerolinea: r.codigo_aerolinea || "",
            ruta: ruta,
            fecha_reserva: r.fecha_reserva || r.fecha_registro || r.fecha,
            fecha_raw: r.fecha_reserva || r.fecha_registro || r.fecha,
          };
        });
      }

      // -------- init ----------
      async function init() {
        if (!currentUser || !currentUser.id_usuario) {
          listaEl.innerHTML =
            '<div class="bg-white rounded-xl shadow p-6 text-center text-gray-600">' +
            "Debes iniciar sesión para ver tus reservas. " +
            '<a class="text-blue-600 font-semibold" href="/views/login.html">Ir a login</a>' +
            "</div>";
          return;
        }

        // loader inicial
        listaEl.innerHTML =
          '<div class="bg-white rounded-xl shadow p-6">' +
          '<div class="animate-pulse space-y-3">' +
          '<div class="h-4 bg-gray-200 rounded w-1/3"></div>' +
          '<div class="h-4 bg-gray-200 rounded w-2/3"></div>' +
          '<div class="h-4 bg-gray-200 rounded w-1/2"></div>' +
          "</div>" +
          "</div>";

        try {
          var data = await cargarReservasUsuario(currentUser.id_usuario);
          reservasRaw = data;
          reservasView = proyectarReservasCrudas(reservasRaw);
          pintarLista();
        } catch (e) {
          lblErrores.textContent =
            e.message || "No se pudieron cargar las reservas.";
          listaEl.innerHTML =
            '<div class="bg-white rounded-xl shadow p-6 text-center text-red-600">Error: ' +
            lblErrores.textContent +
            "</div>";
        }
      }

      // filtros UI
      scopeBtns.forEach(function (b) {
        b.addEventListener("click", function () {
          scopeBtns.forEach(function (x) {
            x.className =
              "tab-scope bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200";
          });
          b.className =
            "tab-scope bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold";
          scope = b.getAttribute("data-scope") || "all";
          pintarLista();
        });
      });
      txtBuscar.addEventListener("input", pintarLista);
      ordenSelect.addEventListener("change", pintarLista);

      document.addEventListener("DOMContentLoaded", init);
    </script>

    <!-- SCRIPT COMPARTIDO DEL HOME (muestra/oculta Mis Reservas + login/logout) -->
    <script>
      (function () {
        let user = null;
        try {
          const raw = localStorage.getItem("currentUser");
          if (raw) user = JSON.parse(raw);
        } catch (e) {}

        const navMisReservas = document.getElementById("nav-mis-reservas");
        const footerMisReservas = document.getElementById(
          "footer-mis-reservas"
        );
        const loginBtn = document.getElementById("login-button");
        const userMenu = document.getElementById("user-menu");

        if (user && user.id_usuario) {
          // usuario autenticado
          if (navMisReservas) navMisReservas.classList.remove("hidden");
          if (footerMisReservas) footerMisReservas.classList.remove("hidden");

          if (loginBtn) loginBtn.classList.add("hidden");
          if (userMenu) userMenu.classList.remove("hidden");
        } else {
          // usuario NO autenticado
          if (navMisReservas) navMisReservas.classList.add("hidden");
          if (footerMisReservas) footerMisReservas.classList.add("hidden");

          if (loginBtn) loginBtn.classList.remove("hidden");
          if (userMenu) userMenu.classList.add("hidden");
        }
      })();
    </script>
  </body>
</html>
