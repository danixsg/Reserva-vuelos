<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - AereoSky</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="/services/auth.js" defer></script>

    <style>
        body { font-family: 'Poppins', sans-serif; }
        input:read-only {
            background-color: #f3f4f6; 
            cursor: not-allowed;
            color: #4b5563; 
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- NAVBAR (igual home.html) -->
    <nav class="bg-white shadow-lg fixed w-full z-10">
      <div class="container mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <svg
              class="h-8 w-8 text-blue-600 mr-2"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
            <a
              href="../../index.html"
              class="text-2xl font-bold text-gray-800"
              >AereoSky</a
            >
          </div>

          <div class="hidden md:flex items-center space-x-6">
            <a
              href="../../index.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Home</a
            >
            <a
              href="/views/consulta-vuelos.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Vuelos</a
            >

            <a
              href="/views/mis-reservas.html"
              id="nav-mis-reservas"
              class="hidden text-gray-600 hover:text-blue-600 transition duration-300"
              >Mis Reservas</a
            >

            <a
              href="/views/contacto.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Contacto</a
            >

            <div id="admin-panel" class="hidden relative">
              <button
                id="admin-panel-button"
                class="flex items-center text-gray-600 font-semibold hover:text-blue-600 p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition"
              >
                <span>Administración</span>
                <svg
                  class="h-5 w-5 ml-1"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <div
                id="admin-panel-menu"
                class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-20"
              >
                <a
                  href="/views/aviones.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Aviones</a
                >
                <a
                  href="/views/aerolineas.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Aerolineas</a
                >
                <a
                  href="/views/fabricantes.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Fabricantes</a
                >
                <a
                  href="/views/usuarios.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Usuarios</a
                >
                <a
                  href="/views/reservas.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Reservas</a
                >
              </div>
            </div>
          </div>

          <a
            href="/views/login.html"
            id="login-button"
            class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 shadow"
          >
            Iniciar Sesión
          </a>
          <div id="user-menu" class="hidden items-center space-x-4">
            <a
              href="/views/perfil.html"
              class="text-gray-600 hover:text-blue-600 font-medium"
              >Mi Perfil</a
            >
            <button
              id="logout-button"
              class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition duration-300 shadow"
            >
              Cerrar Sesión
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- SECCIÓN PERFIL -->
    <main class="pt-24 pb-12">
        <div class="container mx-auto px-6">
            <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div class="p-8 bg-gray-50 border-b">
                    <h1 class="text-3xl font-bold text-gray-800">Mi Perfil</h1>
                    <p class="mt-1 text-gray-600">Actualiza tu información personal y de contacto.</p>
                </div>

                <form id="profileForm" class="p-8 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="nombres" class="block text-sm font-medium text-gray-700">Nombres</label>
                            <input type="text" id="nombres" readonly class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="apellidos" class="block text-sm font-medium text-gray-700">Apellidos</label>
                            <input type="text" id="apellidos" readonly class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="cedula" class="block text-sm font-medium text-gray-700">Cédula</label>
                            <input type="text" id="cedula" readonly class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="correo" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                            <input type="email" id="correo" readonly class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                            <input type="tel" id="telefono" readonly class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="direccion" class="block text-sm font-medium text-gray-700">Dirección</label>
                            <input type="text" id="direccion" readonly class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="pt-6 flex flex-wrap justify-end items-center gap-4 border-t border-gray-200">
                        <button type="button" id="change-password-button" class="bg-blue-800 text-white font-bold px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                            Cambiar Contraseña
                        </button>
                        <button type="button" id="edit-button" class="bg-blue-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                            Editar Perfil
                        </button>
                        <button type="submit" id="save-button" class="hidden bg-green-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- MODAL CAMBIO DE CONTRASEÑA -->
    <div id="password-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md relative animate-fade-in-up">
            <button id="close-password-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Cambiar Contraseña</h2>
            <form id="passwordForm" class="space-y-4">
                <div>
                    <label for="current-password" class="block text-sm font-medium text-gray-700">Contraseña Actual</label>
                    <input type="password" id="current-password" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                    <input type="password" id="new-password" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contraseña</label>
                    <input type="password" id="confirm-password" required class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold p-3 rounded-lg hover:bg-blue-700 transition">Guardar Contraseña</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MÉTODOS DE PAGO -->
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
        <div class="p-8 bg-gray-50 border-b flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Métodos de Pago</h2>
                <p class="mt-1 text-gray-600">Administra tus tarjetas guardadas.</p>
            </div>
            <button id="add-tarjeta-button" class="bg-blue-600 text-white font-bold px-5 py-2.5 rounded-lg hover:bg-blue-700 flex items-center">
                <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                Agregar Tarjeta
            </button>
        </div>
        <div id="tarjetas-container" class="p-8 space-y-4">
            <p class="text-center text-gray-500">Cargando métodos de pago...</p>
        </div>
    </div>

    <!-- MODAL TARJETA -->
    <div id="tarjeta-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg relative">
            <button id="close-tarjeta-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 id="tarjeta-modal-title" class="text-2xl font-bold text-gray-800 mb-6">Agregar Nueva Tarjeta</h2>
            <form id="tarjeta-form" class="space-y-4">
                <div>
                    <label for="numero_tarjeta" class="block text-sm font-medium text-gray-700">Número de Tarjeta</label>
                    <input type="text" id="numero_tarjeta" required class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="16" placeholder="0000 0000 0000 0000">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label for="fecha_mes" class="block text-sm font-medium text-gray-700">Vencimiento (MM/YY)</label>
                        <div class="mt-1 flex items-center px-4 py-2 border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-blue-500 bg-white">
                            <input type="text" id="fecha_mes" placeholder="MM" required class="w-8 border-none p-0 focus:ring-0 text-center" maxlength="2">
                            <span class="text-gray-400">/</span>
                            <input type="text" id="fecha_anio" placeholder="YY" required class="w-8 border-none p-0 focus:ring-0 text-center" maxlength="2">
                        </div>
                    </div>
                    <div>
                        <label for="codigo_seguridad" class="block text-sm font-medium text-gray-700">CVV</label>
                        <input type="text" id="codigo_seguridad" required class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" maxlength="3" placeholder="123">
                    </div>
                </div>
                <div>
                    <label for="tipo_tarjeta" class="block text-sm font-medium text-gray-700">Tipo de Tarjeta</label>
                    <select id="tipo_tarjeta" required class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">Seleccione un tipo</option>
                        <option value="Visa">Visa</option>
                        <option value="Mastercard">Mastercard</option>
                        <option value="American Express">American Express</option>
                    </select>
                </div>
                <div class="pt-4 flex justify-end gap-4">
                    <button type="button" id="cancel-tarjeta-button" class="bg-gray-200 text-gray-800 font-bold px-6 py-2 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold px-6 py-2 rounded-lg">Guardar Tarjeta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- FOOTER (igual home.html) -->
    <footer class="bg-gray-800 text-white py-10 mt-16">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h4 class="text-lg font-semibold mb-4">AereoSky</h4>
            <p class="text-gray-400">
              Tu compañero de viaje ideal. Hacemos que la reserva de vuelos sea
              simple, rápida y asequible.
            </p>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Enlaces Rápidos</h4>
            <ul class="space-y-2 text-gray-400" id="footer-links">
              <li>
                <a
                  href="../../index.html"
                  class="hover:text-white"
                  >Home</a
                >
              </li>
              <li>
                <a
                  href="/views/consulta-vuelos.html"
                  class="hover:text-white"
                  >Vuelos</a
                >
              </li>
              <!-- Mis Reservas (solo autenticado) -->
              <li id="footer-mis-reservas" class="hidden">
                <a
                  href="/views/mis-reservas.html"
                  class="hover:text-white"
                  >Mis Reservas</a
                >
              </li>
              <li>
                <a
                  href="/views/contacto.html"
                  class="hover:text-white"
                  >Contacto</a
                >
              </li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Contacto</h4>
            <ul class="space-y-2 text-gray-400">
              <li>Email: soporte@AereoSky.com</li>
              <li>Teléfono: +593 985 514 590</li>
              <li>Dirección: Machala, Ecuador</li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Síguenos</h4>
            <div class="flex space-x-4">
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.28C8.28,9.09 5.11,7.38 2.9,4.79C2.53,5.42 2.33,6.16 2.33,6.94C2.33,8.43 3.08,9.75 4.18,10.53C3.49,10.51 2.82,10.31 2.22,10V10.06C2.22,12.23 3.78,14.05 5.9,14.45C5.55,14.54 5.18,14.59 4.8,14.59C4.54,14.59 4.28,14.56 4.03,14.51C4.6,16.28 6.26,17.56 8.24,17.6C6.68,18.81 4.77,19.53 2.72,19.53C2.38,19.53 2.05,19.51 1.72,19.46C3.72,20.78 6.11,21.56 8.75,21.56C16.01,21.56 20.24,15.71 20.24,10.65C20.24,10.46 20.24,10.27 20.23,10.08C21.02,9.49 21.8,8.78 22.46,7.92V6Z"
                  /></svg
              ></a>
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.32 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96C18.34 21.21 22 17.06 22 12.06C22 6.53 17.5 2.04 12 2.04Z"
                  /></svg
              ></a>
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7Z"
                  /></svg
              ></a>
            </div>
          </div>
        </div>
        <div
          class="mt-8 border-t border-gray-700 pt-6 text-center text-gray-500"
        >
          <p>&copy; 2025 AereoSky. Todos los derechos reservados.</p>
        </div>
      </div>
    </footer>

    <!-- SCRIPT PRINCIPAL -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const user = JSON.parse(localStorage.getItem('currentUser'));

        if (!user || !user.id_usuario) {
            alert('Debes iniciar sesión para ver tu perfil.');
            window.location.href = '/views/login.html';
            return;
        }

        // --- refs perfil ---
        const form = document.getElementById('profileForm');
        const inputs = form.querySelectorAll('input');
        const editButton = document.getElementById('edit-button');
        const saveButton = document.getElementById('save-button');

        // cargar datos usuario
        const fetchAndDisplayUser = async () => {
            try {
                const response = await fetch(`https://reserva-vuelos-backend.onrender.com/get-usuario/${user.id_usuario}`);
                if (!response.ok) {
                    throw new Error('No se pudo obtener la información del usuario.');
                }
                const userData = await response.json();
                
                document.getElementById('nombres').value = `${userData.p_nombre || ''} ${userData.s_nombre || ''}`.trim();
                document.getElementById('apellidos').value = `${userData.p_apellido || ''} ${userData.s_apellido || ''}`.trim();
                document.getElementById('cedula').value = userData.cedula || '';
                document.getElementById('correo').value = userData.correo || '';
                document.getElementById('telefono').value = userData.telefono || '';
                document.getElementById('direccion').value = userData.direccion || '';

            } catch (error) {
                console.error("Error:", error);
                alert(`Error: ${error.message}`);
            }
        };

        // modo edición
        editButton.addEventListener('click', () => {
            inputs.forEach(input => {
                if (input.id !== '') {
                    input.readOnly = false;
                }
            });
            editButton.classList.add('hidden');
            saveButton.classList.remove('hidden');
            document.getElementById('nombres').focus(); 
        });

        // guardar cambios perfil
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const [p_nombre, ...s_nombre_parts] = document.getElementById('nombres').value.trim().split(' ');
            const s_nombre = s_nombre_parts.join(' ');
            const [p_apellido, ...s_apellido_parts] = document.getElementById('apellidos').value.trim().split(' ');
            const s_apellido = s_apellido_parts.join(' ');

            const updatedData = {
                cedula: document.getElementById('cedula').value.trim(),
                p_nombre: p_nombre,
                s_nombre: s_nombre,
                p_apellido: p_apellido,
                s_apellido: s_apellido,
                correo: document.getElementById('correo').value.trim(),
                telefono: document.getElementById('telefono').value.trim(),
                direccion: document.getElementById('direccion').value.trim()
            };

            try {
                const response = await fetch(`https://reserva-vuelos-backend.onrender.com/update-usuario/${user.id_usuario}`, {
                    method: 'PUT', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Error al actualizar.');
                }

                alert('✅ Perfil actualizado correctamente.');

                // sincronizar storage (por ej. si cambió correo)
                const updatedUserInStorage = { ...user, correo: updatedData.correo };
                localStorage.setItem('currentUser', JSON.stringify(updatedUserInStorage));

                inputs.forEach(input => input.readOnly = true);
                saveButton.classList.add('hidden');
                editButton.classList.remove('hidden');

            } catch (error) {
                console.error("Error al actualizar:", error);
                alert(`⚠️ ${error.message}`);
            }
        });

        // --- CAMBIAR CONTRASEÑA ---
        const changePasswordButton = document.getElementById('change-password-button');
        const passwordModal = document.getElementById('password-modal');
        const closePasswordModalButton = document.getElementById('close-password-modal');
        const passwordForm = document.getElementById('passwordForm');

        changePasswordButton.addEventListener('click', () => {
            passwordModal.classList.remove('hidden');
        });

        const hidePasswordModal = () => {
            passwordModal.classList.add('hidden');
            passwordForm.reset(); 
        };

        closePasswordModalButton.addEventListener('click', hidePasswordModal);
        passwordModal.addEventListener('click', (e) => {
            if (e.target === passwordModal) {
                hidePasswordModal();
            }
        });

        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                return alert('Todos los campos son obligatorios.');
            }
            if (newPassword !== confirmPassword) {
                return alert('Las nuevas contraseñas no coinciden.');
            }

            const payload = {
                currentPassword: currentPassword,
                newPassword: newPassword
            };
            
            try {
                const response = await fetch(`https://reserva-vuelos-backend.onrender.com/update-password/${user.id_usuario}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Error al cambiar la contraseña.');
                }

                alert('✅ Contraseña actualizada correctamente.');
                hidePasswordModal(); 
                
            } catch (error) {
                console.error("Error al cambiar contraseña:", error);
                alert(`⚠️ ${error.message}`);
            }
        });

        // --- TARJETAS / MÉTODOS DE PAGO ---
        const tarjetasContainer = document.getElementById('tarjetas-container');
        const addTarjetaButton = document.getElementById('add-tarjeta-button');
        const tarjetaModal = document.getElementById('tarjeta-modal');
        const closeTarjetaModalButton = document.getElementById('close-tarjeta-modal');
        const cancelTarjetaButton = document.getElementById('cancel-tarjeta-button');
        const tarjetaForm = document.getElementById('tarjeta-form');
        const fechaMesInput = document.getElementById('fecha_mes');
        const fechaAnioInput = document.getElementById('fecha_anio');
        const numeroTarjetaInput = document.getElementById('numero_tarjeta');
        const codigoSeguridadInput = document.getElementById('codigo_seguridad');

        // permitir solo números en varios campos
        const restrictToNumbers = (e) => { e.target.value = e.target.value.replace(/\D/g, ''); };
        numeroTarjetaInput.addEventListener('input', restrictToNumbers);
        codigoSeguridadInput.addEventListener('input', restrictToNumbers);
        fechaMesInput.addEventListener('input', restrictToNumbers);
        fechaAnioInput.addEventListener('input', restrictToNumbers);

        // salto automático MM -> YY
        fechaMesInput.addEventListener('input', (e) => {
            if (e.target.value.length === 2) {
                fechaAnioInput.focus();
            }
        });

        // bloquear teclas no numéricas
        const allowOnlyNumbers = (e) => {
            if (['Backspace', 'ArrowLeft', 'ArrowRight', 'Tab', 'Delete'].includes(e.key)) {
                return;
            }
            if (!/^\d$/.test(e.key)) {
                e.preventDefault();
            }
        };

        numeroTarjetaInput.addEventListener('keydown', allowOnlyNumbers);
        codigoSeguridadInput.addEventListener('keydown', allowOnlyNumbers);
        fechaAnioInput.addEventListener('keydown', allowOnlyNumbers);

        // MM válido (01-12)
        fechaMesInput.addEventListener('keydown', (e) => {
            const currentValue = e.target.value;
            const key = e.key;

            if (['Backspace', 'ArrowLeft', 'ArrowRight', 'Tab', 'Delete'].includes(key)) {
                return;
            }

            if (!/^\d$/.test(key)) {
                e.preventDefault();
                return;
            }

            if (currentValue.length === 0 && key > '1') {
                e.preventDefault();
                return;
            }
            
            if (currentValue.length === 1) {
                if (currentValue === '1' && key > '2') {
                    e.preventDefault();
                    return;
                }
                if (currentValue === '0' && key === '0') {
                    e.preventDefault();
                    return;
                }
            }
        });
        
        // autocompletar 0X si dejan solo 1 dígito
        fechaMesInput.addEventListener('blur', (e) => {
            if (e.target.value.length === 1) {
                e.target.value = '0' + e.target.value;
            }
        });

        // traer tarjetas del usuario
        const fetchTarjetas = async () => {
            try {
                const response = await fetch(`https://reserva-vuelos-backend.onrender.com/tarjetas/usuario/${user.id_usuario}`);
                const tarjetas = await response.json();
                
                tarjetasContainer.innerHTML = '';
                if (!response.ok || tarjetas.length === 0) {
                    tarjetasContainer.innerHTML = '<p class="text-center text-gray-500">No tienes métodos de pago guardados.</p>';
                    return;
                }

                tarjetas.forEach(tarjeta => {
                    const cardHTML = `
                        <div class="border rounded-lg p-4 flex justify-between items-center bg-gray-50 transition hover:shadow-md">
                            <div class="flex items-center gap-4">
                                <img src="https://cdn-icons-png.freepik.com/512/4822/4822663.png" alt="${tarjeta.tipo_tarjeta}" class="h-8">
                                <div>
                                    <p class="font-semibold text-gray-800">${tarjeta.tipo_tarjeta}</p>
                                    <p class="text-sm text-gray-500">${tarjeta.numero_enmascarado} • Vence: ${tarjeta.fecha_vencimiento.substring(0, 10)}</p>
                                </div>
                            </div>
                            <div>
                                <button class="delete-tarjeta-btn text-sm text-red-600 hover:text-red-800 font-semibold" data-id="${tarjeta.id_tarjeta}">Eliminar</button>
                            </div>
                        </div>`;
                    tarjetasContainer.innerHTML += cardHTML;
                });
            } catch (error) {
                console.error("Error al cargar tarjetas:", error);
                tarjetasContainer.innerHTML = '<p class="text-center text-red-500">No se pudieron cargar los métodos de pago.</p>';
            }
        };

        // abrir/cerrar modal tarjeta
        const openTarjetaModal = () => {
            tarjetaForm.reset();
            tarjetaModal.classList.remove('hidden');
        };
        const closeTarjetaModal = () => tarjetaModal.classList.add('hidden');

        // guardar tarjeta nueva
        tarjetaForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const mes = fechaMesInput.value.trim();
            const anio = fechaAnioInput.value.trim();

            if (mes.length !== 2 || anio.length !== 2) {
                return alert('⚠️ Error: La fecha de vencimiento es inválida. Asegúrate de llenar MM y YY.');
            }

            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear(); 

            const inputMonth = parseInt(mes, 10);
            const inputYear = parseInt(`20${anio}`, 10);

            if (inputYear < currentYear) {
                return alert('⚠️ Error: La tarjeta de crédito está vencida (el año ya pasó).');
            }

            if (inputYear === currentYear && inputMonth < currentMonth) {
                return alert('⚠️ Error: La tarjeta de crédito está vencida (el mes ya pasó).');
            }

            const fechaParaDB = `20${anio}-${mes}-01`;

            const formData = {
                id_usuario: user.id_usuario,
                numero: document.getElementById('numero_tarjeta').value,
                fecha_vencimiento: fechaParaDB, 
                codigo_seguridad: document.getElementById('codigo_seguridad').value,
                tipo_tarjeta: document.getElementById('tipo_tarjeta').value,
            };

            try {
                const res = await fetch('https://reserva-vuelos-backend.onrender.com/tarjetas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.message);
                
                alert(`✅ ${result.message}`);
                closeTarjetaModal();
                fetchTarjetas(); 
            } catch (error) {
                alert(`⚠️ Error: ${error.message}`);
            }
        });

        // eliminar tarjeta
        tarjetasContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-tarjeta-btn')) {
                const id = e.target.dataset.id;
                if (confirm('¿Estás seguro de que deseas eliminar esta tarjeta?')) {
                    try {
                        const res = await fetch(`https://reserva-vuelos-backend.onrender.com/tarjetas/${id}`, { method: 'DELETE' });
                        const result = await res.json();
                        if (!res.ok) throw new Error(result.message);
                        alert(`✅ ${result.message}`);
                        fetchTarjetas();
                    } catch (error) {
                        alert(`⚠️ Error: ${error.message}`);
                    }
                }
            }
        });

        addTarjetaButton.addEventListener('click', openTarjetaModal);
        closeTarjetaModalButton.addEventListener('click', closeTarjetaModal);
        cancelTarjetaButton.addEventListener('click', closeTarjetaModal);

        // inicializar vista
        fetchTarjetas();
        fetchAndDisplayUser();

        // --- SINCRONIZAR NAVBAR/FOOTER CON SESIÓN Y ROL ---
        (function syncSessionUI() {
          let u = null;
          try {
            const raw = localStorage.getItem("currentUser");
            if (raw) u = JSON.parse(raw);
          } catch (e) {}

          const navMisReservas = document.getElementById("nav-mis-reservas");
          const footerMisReservas = document.getElementById("footer-mis-reservas");
          const loginBtn = document.getElementById("login-button");
          const userMenu = document.getElementById("user-menu");
          const adminPanel = document.getElementById("admin-panel");

          if (u && u.id_usuario) {
            if (navMisReservas) navMisReservas.classList.remove("hidden");
            if (footerMisReservas) footerMisReservas.classList.remove("hidden");
            if (loginBtn) loginBtn.classList.add("hidden");
            if (userMenu) userMenu.classList.remove("hidden");
            if (adminPanel && u.rol === "Administrador") {
              adminPanel.classList.remove("hidden");
            }
          } else {
            if (navMisReservas) navMisReservas.classList.add("hidden");
            if (footerMisReservas) footerMisReservas.classList.add("hidden");
            if (loginBtn) loginBtn.classList.remove("hidden");
            if (userMenu) userMenu.classList.add("hidden");
          }
        })();

    }); // DOMContentLoaded
    </script>
</body>
</html>
