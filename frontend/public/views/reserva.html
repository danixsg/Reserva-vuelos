<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Confirmar reserva - AereoSky</title>

    <!-- igual que home.html -->
    <script src="/services/auth.js" defer></script>

    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />

    <!-- misma fuente que home.html -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      }
    </style>
  </head>

  <body
    class="bg-gradient-to-br from-blue-50 to-blue-200 min-h-screen flex flex-col text-gray-800"
  >
    <!-- NAVBAR (idéntico al de home.html) -->
    <nav class="bg-white shadow-lg fixed w-full z-10">
      <div class="container mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <svg
              class="h-8 w-8 text-blue-600 mr-2"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
            <a
              href="../../index.html"
              class="text-2xl font-bold text-gray-800"
              >AereoSky</a
            >
          </div>

          <div class="hidden md:flex items-center space-x-6">
            <a
              href="../../index.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Home</a
            >
            <a
              href="/views/consulta-vuelos.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Vuelos</a
            >

            <!-- Mis Reservas (visible solo si está logueado) -->
            <a
              href="/views/mis-reservas.html"
              id="nav-mis-reservas"
              class="hidden text-gray-600 hover:text-blue-600 transition duration-300"
              >Mis Reservas</a
            >

            <a
              href="/views/contacto.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Contacto</a
            >

            <div id="admin-panel" class="hidden relative">
              <button
                id="admin-panel-button"
                class="flex items-center text-gray-600 font-semibold hover:text-blue-600 p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition"
              >
                <span>Administración</span>
                <svg
                  class="h-5 w-5 ml-1"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <div
                id="admin-panel-menu"
                class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-20"
              >
                <a
                  href="/views/aviones.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Aviones</a
                >
                <a
                  href="/views/aerolineas.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Aerolineas</a
                >
                <a
                  href="/views/fabricantes.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Fabricantes</a
                >
                <a
                  href="/views/usuarios.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Usuarios</a
                >
                <a
                  href="/views/reservas.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Reservas</a
                >
              </div>
            </div>
          </div>

          <a
            href="/views/login.html"
            id="login-button"
            class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 shadow"
          >
            Iniciar Sesión
          </a>

          <div id="user-menu" class="hidden items-center space-x-4">
            <a
              href="/views/perfil.html"
              class="text-gray-600 hover:text-blue-600 font-medium"
              >Mi Perfil</a
            >
            <button
              id="logout-button"
              class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition duration-300 shadow"
            >
              Cerrar Sesión
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Contenido original (sin tocar estructura/clases) -->
    <main class="pt-24 pb-12 flex-1 container mx-auto px-4 py-8 max-w-lg">
      <div class="bg-white border border-gray-200 shadow rounded-xl p-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Confirmar reserva</h1>
        <p class="text-sm text-gray-600 mb-6">
          Selecciona la categoría de asiento para tu reserva.
        </p>

        <form id="reservaForm" class="space-y-4">
          <!-- Select dinámico de categoría -->
          <div>
            <label
              for="id_categoria"
              class="block text-sm font-medium text-gray-700"
            >
              Categoría de asiento
            </label>

            <select
              id="id_categoria"
              class="mt-1 w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500"
              required
            >
              <option value="" disabled selected>Cargando categorías...</option>
            </select>

            <p
              id="catInfo"
              class="text-xs text-gray-500 mt-2 leading-relaxed"
            ></p>
          </div>

          <button
            type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow transition disabled:bg-gray-400 disabled:cursor-not-allowed"
            id="btnConfirmarReserva"
          >
            Crear reserva
          </button>
        </form>

        <div
          id="resultadoReserva"
          class="hidden mt-6 p-4 rounded-lg border text-sm"
        ></div>
      </div>
    </main>

    <!-- FOOTER (idéntico al de home.html) -->
    <footer class="bg-gray-800 text-white py-10">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h4 class="text-lg font-semibold mb-4">AereoSky</h4>
            <p class="text-gray-400">
              Tu compañero de viaje ideal. Hacemos que la reserva de vuelos sea
              simple, rápida y asequible.
            </p>
          </div>

          <div>
            <h4 class="text-lg font-semibold mb-4">Enlaces Rápidos</h4>
            <ul class="space-y-2 text-gray-400" id="footer-links">
              <li>
                <a href="../../index.html" class="hover:text-white">Home</a>
              </li>
              <li>
                <a
                  href="/views/consulta-vuelos.html"
                  class="hover:text-white"
                  >Vuelos</a
                >
              </li>
              <!-- Mis Reservas (solo autenticado) -->
              <li id="footer-mis-reservas" class="hidden">
                <a href="/views/mis-reservas.html" class="hover:text-white"
                  >Mis Reservas</a
                >
              </li>
              <li>
                <a href="/views/contacto.html" class="hover:text-white"
                  >Contacto</a
                >
              </li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg font-semibold mb-4">Contacto</h4>
            <ul class="space-y-2 text-gray-400">
              <li>Email: soporte@AereoSky.com</li>
              <li>Teléfono: +593 985 514 590</li>
              <li>Dirección: Machala, Ecuador</li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg font-semibold mb-4">Síguenos</h4>
            <div class="flex space-x-4">
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.28C8.28,9.09 5.11,7.38 2.9,4.79C2.53,5.42 2.33,6.16 2.33,6.94C2.33,8.43 3.08,9.75 4.18,10.53C3.49,10.51 2.82,10.31 2.22,10V10.06C2.22,12.23 3.78,14.05 5.9,14.45C5.55,14.54 5.18,14.59 4.8,14.59C4.54,14.59 4.28,14.56 4.03,14.51C4.6,16.28 6.26,17.56 8.24,17.6C6.68,18.81 4.77,19.53 2.72,19.53C2.38,19.53 2.05,19.51 1.72,19.46C3.72,20.78 6.11,21.56 8.75,21.56C16.01,21.56 20.24,15.71 20.24,10.65C20.24,10.46 20.24,10.27 20.23,10.08C21.02,9.49 21.8,8.78 22.46,7.92V6Z"
                  /></svg
              ></a>
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.32 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96C18.34 21.21 22 17.06 22 12.06C22 6.53 17.5 2.04 12 2.04Z"
                  /></svg
              ></a>
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7Z"
                  /></svg
              ></a>
            </div>
          </div>
        </div>

        <div
          class="mt-8 border-t border-gray-700 pt-6 text-center text-gray-500"
        >
          <p>&copy; 2025 AereoSky. Todos los derechos reservados.</p>
        </div>
      </div>
    </footer>

    <!-- SCRIPT PRINCIPAL DE LA PÁGINA (tu lógica original) -->
    <script>
      // 1. leer usuario logueado desde localStorage
      let currentUser = null;
      try {
        const raw = localStorage.getItem("currentUser");
        if (raw) currentUser = JSON.parse(raw);
      } catch (e) {}

      const userInfoEl = document.getElementById("user-info");

      if (userInfoEl) {
        if (!currentUser) {
          userInfoEl.textContent = "No autenticado";
        } else {
          userInfoEl.textContent = "Sesión: " + currentUser.correo;
        }
      }

      // 2. leer id_vuelo de la URL (?id_vuelo=123)
      const params = new URLSearchParams(window.location.search);
      const idVuelo = params.get("id_vuelo");

      // refs del DOM
      const selectCategoria = document.getElementById("id_categoria");
      const catInfo = document.getElementById("catInfo");
      const formEl = document.getElementById("reservaForm");
      const resBox = document.getElementById("resultadoReserva");
      const btnSubmit = document.getElementById("btnConfirmarReserva");

      // 3. cargar categorías desde backend
      async function cargarCategorias() {
        try {
          const resp = await fetch("https://reserva-vuelos-backend.onrender.com/categorias-asiento");
          const data = await resp.json();

          if (!resp.ok) {
            selectCategoria.innerHTML =
              '<option value="" disabled selected>Error al cargar categorías</option>';
            return;
          }

          selectCategoria.innerHTML =
            '<option value="" disabled selected>Selecciona una categoría</option>';

          data.forEach((cat) => {
            const opt = document.createElement("option");
            opt.value = cat.id_categoria;
            opt.textContent =
              cat.categoria + " - $" + Number(cat.precio_categoria).toFixed(2);
            opt.dataset.rango = cat.rango_inicio + "-" + cat.rango_fin;
            opt.dataset.precio = cat.precio_categoria;
            selectCategoria.appendChild(opt);
          });

          selectCategoria.addEventListener("change", () => {
            const opcion = selectCategoria.selectedOptions[0];
            if (!opcion) return;
            const rango = opcion.dataset.rango;
            const nombre = opcion.textContent;
            catInfo.textContent =
              "Clase seleccionada: " +
              nombre +
              ". Rango de asientos " +
              rango +
              ".";
          });
        } catch (err) {
          console.error("Error cargando categorías:", err);
          selectCategoria.innerHTML =
            '<option value="" disabled selected>No se pudo conectar al servidor</option>';
        }
      }

      cargarCategorias();

      // 4. manejar submit de la reserva
      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!currentUser) {
          alert("Debes iniciar sesión para reservar.");
          window.location.href = "/views/login.html";
          return;
        }

        if (!idVuelo) {
          alert("Falta el id del vuelo.");
          return;
        }

        const id_categoria = selectCategoria.value;
        if (!id_categoria) {
          alert("Selecciona una categoría de asiento.");
          return;
        }

        const payload = {
          id_usuario: currentUser.id_usuario,
          id_vuelo: Number(idVuelo),
          id_categoria: Number(id_categoria),
        };

        try {
          btnSubmit.disabled = true;

          const resp = await fetch("https://reserva-vuelos-backend.onrender.com/reservas", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await resp.json();

          resBox.classList.remove("hidden");

          if (resp.ok) {
            resBox.className =
              "mt-6 p-4 rounded-lg border text-sm bg-green-50 border-green-400 text-green-800";
            resBox.innerHTML =
              '<p class="font-semibold mb-2">✅ Reserva creada con éxito</p>' +
              "<p><strong>ID Reserva:</strong> " +
              data.reserva.id_reserva +
              "</p>" +
              "<p><strong>Estado:</strong> " +
              data.reserva.estado +
              "</p>" +
              "<p><strong>Fecha de reserva:</strong> " +
              (data.reserva.fecha_registro || data.reserva.fecha_reserva) +
              "</p>" +
              '<p class="mt-3 text-xs text-gray-600">Tu asiento ha sido apartado. Ahora puedes continuar al pago.</p>' +
              '<a href="/views/compra.html?id_reserva=' +
              data.reserva.id_reserva +
              '" class="mt-4 inline-block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow transition">Proceder al pago</a>';
          } else {
            resBox.className =
              "mt-6 p-4 rounded-lg border text-sm bg-red-50 border-red-400 text-red-800";
            resBox.textContent =
              data.message || "Ocurrió un error creando la reserva.";
          }
        } catch (err) {
          console.error("Error creando reserva:", err);
          resBox.classList.remove("hidden");
          resBox.className =
            "mt-6 p-4 rounded-lg border text-sm bg-red-50 border-red-400 text-red-800";
          resBox.textContent =
            "No se pudo conectar al servidor para crear la reserva.";
        } finally {
          btnSubmit.disabled = false;
        }
      });
    </script>

    <!-- SCRIPT COMPARTIDO DEL HOME (mostrar/ocultar Mis Reservas + login/user menu) -->
    <script>
      (function () {
        let user = null;
        try {
          const raw = localStorage.getItem("currentUser");
          if (raw) user = JSON.parse(raw);
        } catch (e) {}

        const navMisReservas = document.getElementById("nav-mis-reservas");
        const footerMisReservas = document.getElementById(
          "footer-mis-reservas"
        );
        const loginBtn = document.getElementById("login-button");
        const userMenu = document.getElementById("user-menu");

        if (user && user.id_usuario) {
          // usuario autenticado
          if (navMisReservas) navMisReservas.classList.remove("hidden");
          if (footerMisReservas) footerMisReservas.classList.remove("hidden");

          if (loginBtn) loginBtn.classList.add("hidden");
          if (userMenu) userMenu.classList.remove("hidden");
        } else {
          // usuario NO autenticado
          if (navMisReservas) navMisReservas.classList.add("hidden");
          if (footerMisReservas) footerMisReservas.classList.add("hidden");

          if (loginBtn) loginBtn.classList.remove("hidden");
          if (userMenu) userMenu.classList.add("hidden");
        }
      })();
    </script>
  </body>
</html>
