<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Detalle de vuelo - AereoSky</title>

    <!-- mismo script de home para controlar login/logout y admin -->
    <script src="/src/services/auth.js" defer></script>

    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />

    <!-- fuentes como en home.html -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      }
    </style>
  </head>

  <body
    class="bg-gradient-to-br from-blue-50 to-blue-200 min-h-screen flex flex-col text-gray-800"
  >
    <!-- NAVBAR (idéntico al de home.html) -->
    <nav class="bg-white shadow-lg fixed w-full z-10">
      <div class="container mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <svg
              class="h-8 w-8 text-blue-600 mr-2"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
            <a
              href="/src/views/home.html"
              class="text-2xl font-bold text-gray-800"
              >AereoSky</a
            >
          </div>

          <div class="hidden md:flex items-center space-x-6">
            <a
              href="/src/views/home.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Home</a
            >
            <a
              href="/src/views/consulta-vuelos.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Vuelos</a
            >

            <!-- Mis Reservas (visible solo si está logueado) -->
            <a
              href="/src/views/mis-reservas.html"
              id="nav-mis-reservas"
              class="hidden text-gray-600 hover:text-blue-600 transition duration-300"
              >Mis Reservas</a
            >

            <a
              href="/src/views/contacto.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
              >Contacto</a
            >

            <div id="admin-panel" class="hidden relative">
              <button
                id="admin-panel-button"
                class="flex items-center text-gray-600 font-semibold hover:text-blue-600 p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition"
              >
                <span>Administración</span>
                <svg
                  class="h-5 w-5 ml-1"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <div
                id="admin-panel-menu"
                class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-20"
              >
                <a
                  href="/src/views/aviones.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Aviones</a
                >
                <a
                  href="/src/views/aerolineas.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Aerolineas</a
                >
                <a
                  href="/src/views/fabricantes.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Fabricantes</a
                >
                <a
                  href="/src/views/usuarios.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Usuarios</a
                >
                <a
                  href="/src/views/reservas.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                  >Reservas</a
                >
              </div>
            </div>
          </div>

          <a
            href="/src/views/login.html"
            id="login-button"
            class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 shadow"
          >
            Iniciar Sesión
          </a>

          <div id="user-menu" class="hidden items-center space-x-4">
            <a
              href="/src/views/perfil.html"
              class="text-gray-600 hover:text-blue-600 font-medium"
              >Mi Perfil</a
            >
            <button
              id="logout-button"
              class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition duration-300 shadow"
            >
              Cerrar Sesión
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL (SIN CAMBIOS) -->
    <main class="pt-28 pb-12 flex-1 container mx-auto px-4 max-w-3xl">
      <div
        id="cardVuelo"
        class="bg-white shadow-lg rounded-xl p-6 border border-gray-200"
      >
        <h1 class="text-2xl font-bold text-gray-900 mb-4">Detalle del vuelo</h1>

        <div id="vueloInfo" class="space-y-3 text-gray-700 text-sm">
          Cargando información del vuelo...
        </div>

        <div class="mt-6 border-t pt-6 flex justify-between items-center">
          <div>
            <div class="text-gray-500 text-xs uppercase tracking-wide">
              Precio por pasajero
            </div>
            <div id="precioPorPersona" class="text-2xl font-bold text-blue-600">
              -
            </div>
          </div>

          <button
            id="btnReservar"
            class="bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg shadow hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
          >
            Reservar este vuelo
          </button>
        </div>

        <p class="text-xs text-gray-500 mt-3 leading-relaxed">
          La reserva bloqueará los asientos seleccionados bajo la tarifa
          mostrada. El pago del boleto se realiza después.
        </p>
      </div>
    </main>

    <!-- FOOTER (idéntico al de home.html) -->
    <footer class="bg-gray-800 text-white py-10">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h4 class="text-lg font-semibold mb-4">AereoSky</h4>
            <p class="text-gray-400">
              Tu compañero de viaje ideal. Hacemos que la reserva de vuelos sea
              simple, rápida y asequible.
            </p>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Enlaces Rápidos</h4>
            <ul class="space-y-2 text-gray-400" id="footer-links">
              <li>
                <a
                  href="/src/views/home.html"
                  class="hover:text-white"
                  >Home</a
                >
              </li>
              <li>
                <a
                  href="/src/views/consulta-vuelos.html"
                  class="hover:text-white"
                  >Vuelos</a
                >
              </li>
              <!-- Mis Reservas (solo autenticado) -->
              <li id="footer-mis-reservas" class="hidden">
                <a
                  href="/src/views/mis-reservas.html"
                  class="hover:text-white"
                  >Mis Reservas</a
                >
              </li>
              <li>
                <a
                  href="/src/views/contacto.html"
                  class="hover:text-white"
                  >Contacto</a
                >
              </li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Contacto</h4>
            <ul class="space-y-2 text-gray-400">
              <li>Email: soporte@AereoSky.com</li>
              <li>Teléfono: +593 985 514 590</li>
              <li>Dirección: Machala, Ecuador</li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Síguenos</h4>
            <div class="flex space-x-4">
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.28C8.28,9.09 5.11,7.38 2.9,4.79C2.53,5.42 2.33,6.16 2.33,6.94C2.33,8.43 3.08,9.75 4.18,10.53C3.49,10.51 2.82,10.31 2.22,10V10.06C2.22,12.23 3.78,14.05 5.9,14.45C5.55,14.54 5.18,14.59 4.8,14.59C4.54,14.59 4.28,14.56 4.03,14.51C4.6,16.28 6.26,17.56 8.24,17.6C6.68,18.81 4.77,19.53 2.72,19.53C2.38,19.53 2.05,19.51 1.72,19.46C3.72,20.78 6.11,21.56 8.75,21.56C16.01,21.56 20.24,15.71 20.24,10.65C20.24,10.46 20.24,10.27 20.23,10.08C21.02,9.49 21.8,8.78 22.46,7.92V6Z"
                  /></svg
              ></a>
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.32 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96C18.34 21.21 22 17.06 22 12.06C22 6.53 17.5 2.04 12 2.04Z"
                  /></svg
              ></a>
              <a href="#" class="text-gray-400 hover:text-white"
                ><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7Z"
                  /></svg
              ></a>
            </div>
          </div>
        </div>
        <div
          class="mt-8 border-t border-gray-700 pt-6 text-center text-gray-500"
        >
          <p>&copy; 2025 AereoSky. Todos los derechos reservados.</p>
        </div>
      </div>
    </footer>

    <!-- LÓGICA DE LA PÁGINA (SIN CAMBIOS) -->
    <script>
      // Utilidad: formatear fecha y hora bonitos
      function formatDateTime(raw) {
        if (!raw) {
          return { fecha: "N/D", hora: "N/D" };
        }

        // Normalizar "YYYY-MM-DD HH:mm:ss" -> "YYYY-MM-DDTHH:mm:ss"
        var isoCandidate = raw.replace(" ", "T");

        var d = new Date(isoCandidate);

        // Si no parsea, intentamos con "Z" al final (forzando UTC)
        if (isNaN(d.getTime())) {
          var d2 = new Date(isoCandidate + "Z");
          if (!isNaN(d2.getTime())) {
            return {
              fecha: d2.toLocaleDateString("es-EC", {
                year: "numeric",
                month: "long",
                day: "numeric"
              }),
              hora: d2.toLocaleTimeString("es-EC", {
                hour: "2-digit",
                minute: "2-digit"
              })
            };
          }

          // si sigue fallando: fallback seguro
          return { fecha: "N/D", hora: "N/D" };
        }

        return {
          fecha: d.toLocaleDateString("es-EC", {
            year: "numeric",
            month: "long",
            day: "numeric"
          }),
          hora: d.toLocaleTimeString("es-EC", {
            hour: "2-digit",
            minute: "2-digit"
          })
        };
      }

      // agarrar id_vuelo del querystring
      var params = new URLSearchParams(window.location.search);
      var idVuelo = params.get("id_vuelo");

      var vueloInfoEl = document.getElementById("vueloInfo");
      var precioEl = document.getElementById("precioPorPersona");
      var reservarBtn = document.getElementById("btnReservar");

      // Sesión actual (solo para la lógica de reservar)
      var currentUser = null;
      try {
        var raw = localStorage.getItem("currentUser");
        if (raw) {
          currentUser = JSON.parse(raw);
        }
      } catch (e) {}

      if (!currentUser) {
        console.log("Usuario no logueado");
      } else {
        console.log("Usuario logueado:", currentUser.correo);
      }

      if (!idVuelo) {
        vueloInfoEl.textContent =
          "No se proporcionó id_vuelo en la URL. Ejemplo: detalle-vuelo.html?id_vuelo=5";
        reservarBtn.disabled = true;
      } else {
        cargarVuelo(idVuelo);
      }

      async function cargarVuelo(id) {
        try {
          var res = await fetch("http://localhost:3000/vuelo/" + id + "/detalle");
          var data = await res.json();

          if (!res.ok) {
            vueloInfoEl.textContent =
              data.message || "Error cargando vuelo.";
            reservarBtn.disabled = true;
            return;
          }

          var salidaFmt = formatDateTime(data.fecha_salida);
          var llegadaFmt = formatDateTime(data.fecha_llegada);

          // Pintar info
          var html = "";
          html += '<div>';
          html +=
            '<div class="text-xs uppercase text-gray-500">Ruta</div>';
          html +=
            '<div class="font-semibold text-gray-900 text-lg">' +
            data.origen_ciudad +
            " (" +
            data.origen_codigo +
            ") → " +
            data.destino_ciudad +
            " (" +
            data.destino_codigo +
            ")</div>";
          html += "</div>";

          html +=
            '<div class="grid grid-cols-2 gap-4 text-sm mt-3">';
          html += '<div>';
          html +=
            '<div class="text-xs text-gray-500 uppercase">Salida</div>';
          html +=
            '<div class="font-medium">' +
            salidaFmt.fecha +
            "</div>";
          html +=
            '<div class="text-gray-800">' +
            salidaFmt.hora +
            "</div>";
          html += "</div>";

          html += '<div>';
          html +=
            '<div class="text-xs text-gray-500 uppercase">Llegada</div>';
          html +=
            '<div class="font-medium">' +
            llegadaFmt.fecha +
            "</div>";
          html +=
            '<div class="text-gray-800">' +
            llegadaFmt.hora +
            "</div>";
          html += "</div>";
          html += "</div>";

          html +=
            '<div class="grid grid-cols-2 gap-4 text-sm mt-3">';
          html += '<div>';
          html +=
            '<div class="text-xs text-gray-500 uppercase">Aerolínea</div>';
          html +=
            '<div class="font-medium">' +
            data.nombre_aerolinea +
            "</div>";
          html +=
            '<div class="text-gray-500 text-xs">' +
            data.codigo_aerolinea +
            "</div>";
          html += "</div>";

          html += '<div>';
          html +=
            '<div class="text-xs text-gray-500 uppercase">Avión</div>';
          html +=
            '<div class="font-medium">' +
            data.modelo_avion +
            "</div>";
          html +=
            '<div class="text-gray-500 text-xs">Matrícula ' +
            data.matricula +
            "</div>";
          html += "</div>";
          html += "</div>";

          html +=
            '<div class="grid grid-cols-2 gap-4 text-sm mt-3">';
          html += '<div>';
          html +=
            '<div class="text-xs text-gray-500 uppercase">Tipo de vuelo</div>';
          html +=
            '<div class="font-medium">' +
            data.tipo_vuelo +
            "</div>";
          html += "</div>";

          html += '<div>';
          html +=
            '<div class="text-xs text-gray-500 uppercase">Estado</div>';
          html +=
            '<div class="font-medium">' +
            data.estado_vuelo +
            "</div>";
          html += "</div>";
          html += "</div>";

          html +=
            '<div class="grid grid-cols-2 gap-4 text-sm mt-3">';
          html += '<div>';
          html +=
            '<div class="text-xs text-gray-500 uppercase">Asientos disponibles</div>';
          html +=
            '<div class="font-medium">' +
            data.asientos_disponibles +
            "</div>";
          html += "</div>";

          html += '<div>';
          html +=
            '<div class="text-xs text-gray-500 uppercase">Tarifa base</div>';
          html +=
            '<div class="font-medium">$ ' +
            Number(data.precio).toFixed(2) +
            "</div>";
          html += "</div>";
          html += "</div>";

          vueloInfoEl.innerHTML = html;
          precioEl.textContent = "$ " + Number(data.precio).toFixed(2);

          // Activar botón reservar
          reservarBtn.disabled = false;
          reservarBtn.addEventListener("click", function () {
            if (!currentUser) {
              window.location.href = "/src/views/login.html";
              return;
            }
            // lleva a pantalla de reserva del vuelo
            window.location.href =
              "/src/views/reserva.html?id_vuelo=" + id;
          });
        } catch (err) {
          console.error("Error cargando vuelo:", err);
          vueloInfoEl.textContent =
            "Error cargando vuelo desde el servidor.";
          reservarBtn.disabled = true;
        }
      }
    </script>

    <!-- SCRIPT COMPARTIDO DE home.html PARA MOSTRAR/OCULTAR "MIS RESERVAS",
         LOGIN / USER-MENU Y LINKS DEL FOOTER -->
    <script>
      (function () {
        let user = null;
        try {
          const raw = localStorage.getItem("currentUser");
          if (raw) user = JSON.parse(raw);
        } catch (e) {}

        const navMisReservas = document.getElementById("nav-mis-reservas");
        const footerMisReservas = document.getElementById("footer-mis-reservas");
        const loginBtn = document.getElementById("login-button");
        const userMenu = document.getElementById("user-menu");

        if (user && user.id_usuario) {
          // usuario autenticado
          if (navMisReservas) navMisReservas.classList.remove("hidden");
          if (footerMisReservas) footerMisReservas.classList.remove("hidden");

          if (loginBtn) loginBtn.classList.add("hidden");
          if (userMenu) userMenu.classList.remove("hidden");
        } else {
          // usuario NO autenticado
          if (navMisReservas) navMisReservas.classList.add("hidden");
          if (footerMisReservas) footerMisReservas.classList.add("hidden");

          if (loginBtn) loginBtn.classList.remove("hidden");
          if (userMenu) userMenu.classList.add("hidden");
        }
      })();
    </script>
  </body>
</html>
