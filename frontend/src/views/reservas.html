<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Reservas - AereoSky Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/src/services/auth.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="bg-white shadow-lg fixed w-full z-10">
      <div class="container mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <svg
              class="h-8 w-8 text-blue-600 mr-2"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
            <a
              href="/src/views/home.html"
              class="text-2xl font-bold text-gray-800"
            >AereoSky</a>
          </div>

          <div class="hidden md:flex items-center space-x-6">
            <a
              href="/src/views/home.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
            >Home</a>
            <a
              href="/src/views/consulta-vuelos.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
            >Vuelos</a>

            <!-- Mis Reservas solo si está logueado -->
            <a
              href="/src/views/mis-reservas.html"
              id="nav-mis-reservas"
              class="hidden text-gray-600 hover:text-blue-600 transition duration-300"
            >Mis Reservas</a>

            <a
              href="/src/views/contacto.html"
              class="text-gray-600 hover:text-blue-600 transition duration-300"
            >Contacto</a>

            <div id="admin-panel" class="hidden relative">
              <button
                id="admin-panel-button"
                class="flex items-center text-gray-600 font-semibold hover:text-blue-600 p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition"
              >
                <span>Administración</span>
                <svg
                  class="h-5 w-5 ml-1"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <div
                id="admin-panel-menu"
                class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-xl z-20"
              >
                <a
                  href="/src/views/aviones.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >Aviones</a>
                <a
                  href="/src/views/aerolineas.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >Aerolíneas</a>
                <a
                  href="/src/views/fabricantes.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >Fabricantes</a>
                <a
                  href="/src/views/usuarios.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >Usuarios</a>
                <a
                  href="/src/views/reservas.html"
                  class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-semibold text-blue-600"
                >Reservas</a>
              </div>
            </div>
          </div>

          <a
            href="/src/views/login.html"
            id="login-button"
            class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 shadow"
          >
            Iniciar Sesión
          </a>

          <div id="user-menu" class="hidden items-center space-x-4">
            <a
              href="/src/views/perfil.html"
              class="text-gray-600 hover:text-blue-600 font-medium"
            >Mi Perfil</a>
            <button
              id="logout-button"
              class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition duration-300 shadow"
            >
              Cerrar Sesión
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL RESERVAS -->
    <main class="pt-24 pb-12">
        <div class="container mx-auto px-6">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Gestión de Reservas</h1>
                <p class="mt-1 text-gray-600">Visualiza y administra todas las reservas de la plataforma.</p>
            </div>

            <!-- filtros / búsqueda -->
            <div class="bg-white rounded-xl shadow p-4 mb-8">
                <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
                    <div class="flex items-center gap-2 flex-wrap">
                        <button data-scope="all" class="tab-scope bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Todos</button>
                        <button data-scope="Pendiente" class="tab-scope bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200">Pendientes</button>
                        <button data-scope="Confirmada" class="tab-scope bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200">Confirmadas</button>
                        <button data-scope="Cancelada" class="tab-scope bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200">Canceladas</button>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3 sm:items-center">
                        <input id="txtBuscar" type="text" placeholder="Buscar por nombre, cédula o correo..." class="w-full sm:w-64 border border-gray-300 rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <select id="ordenResultados" class="border border-gray-300 rounded-md px-2 py-2 text-sm">
                            <option value="nombre-asc">Nombre A → Z</option>
                            <option value="nombre-desc">Nombre Z → A</option>
                            <option value="registro-reciente">Más recientes</option>
                            <option value="registro-antiguo">Más antiguos</option>
                        </select>
                    </div>
                </div>
                <div id="lblResumenLista" class="text-xs text-gray-500 mt-4"></div>
            </div>

            <!-- tabla reservas -->
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID Reserva</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuario</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vuelo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha Reserva</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="reservas-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="text-center p-8 text-gray-500">Cargando reservas...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- FOOTER (igual home.html) -->
    <footer class="bg-gray-800 text-white py-10 mt-16">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h4 class="text-lg font-semibold mb-4">AereoSky</h4>
            <p class="text-gray-400">
              Tu compañero de viaje ideal. Hacemos que la reserva de vuelos sea
              simple, rápida y asequible.
            </p>
          </div>

          <div>
            <h4 class="text-lg font-semibold mb-4">Enlaces Rápidos</h4>
            <ul class="space-y-2 text-gray-400" id="footer-links">
              <li>
                <a href="/src/views/home.html" class="hover:text-white">Home</a>
              </li>
              <li>
                <a href="/src/views/consulta-vuelos.html" class="hover:text-white">Vuelos</a>
              </li>
              <!-- Mis Reservas (solo autenticado) -->
              <li id="footer-mis-reservas" class="hidden">
                <a href="/src/views/mis-reservas.html" class="hover:text-white">Mis Reservas</a>
              </li>
              <li>
                <a href="/src/views/contacto.html" class="hover:text-white">Contacto</a>
              </li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg font-semibold mb-4">Contacto</h4>
            <ul class="space-y-2 text-gray-400">
              <li>Email: soporte@AereoSky.com</li>
              <li>Teléfono: +593 985 514 590</li>
              <li>Dirección: Machala, Ecuador</li>
            </ul>
          </div>

          <div>
            <h4 class="text-lg font-semibold mb-4">Síguenos</h4>
            <div class="flex space-x-4">
              <a href="#" class="text-gray-400 hover:text-white">
                <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.28C8.28,9.09 5.11,7.38 2.9,4.79C2.53,5.42 2.33,6.16 2.33,6.94C2.33,8.43 3.08,9.75 4.18,10.53C3.49,10.51 2.82,10.31 2.22,10V10.06C2.22,12.23 3.78,14.05 5.9,14.45C5.55,14.54 5.18,14.59 4.8,14.59C4.54,14.59 4.28,14.56 4.03,14.51C4.6,16.28 6.26,17.56 8.24,17.6C6.68,18.81 4.77,19.53 2.72,19.53C2.38,19.53 2.05,19.51 1.72,19.46C3.72,20.78 6.11,21.56 8.75,21.56C16.01,21.56 20.24,15.71 20.24,10.65C20.24,10.46 20.24,10.27 20.23,10.08C21.02,9.49 21.8,8.78 22.46,7.92V6Z" />
                </svg>
              </a>
              <a href="#" class="text-gray-400 hover:text-white">
                <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.32 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96C18.34 21.21 22 17.06 22 12.06C22 6.53 17.5 2.04 12 2.04Z" />
                </svg>
              </a>
              <a href="#" class="text-gray-400 hover:text-white">
                <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7Z" />
                </svg>
              </a>
            </div>
          </div>
        </div>

        <div class="mt-8 border-t border-gray-700 pt-6 text-center text-gray-500">
          <p>&copy; 2025 AereoSky. Todos los derechos reservados.</p>
        </div>
      </div>
    </footer>

    <!-- SCRIPT PRINCIPAL -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const user = JSON.parse(localStorage.getItem('currentUser'));
    if (!user || user.rol !== "Administrador") {
        alert('Acceso denegado. Esta sección es solo para administradores.');
        window.location.href = '/src/views/home.html';
        return;
    }

    const tableBody = document.getElementById('reservas-table-body');
    const filterButtons = document.querySelectorAll('.tab-scope');
    const searchInput = document.getElementById('txtBuscar');
    const orderSelect = document.getElementById('ordenResultados');
    const summaryLabel = document.getElementById('lblResumenLista');

    let allReservas = [];
    let currentStatusFilter = 'all';
    let currentSearchTerm = '';
    let currentSortOrder = 'registro-reciente';
    
    const formatFecha = (fechaISO) => {
        const d = new Date(fechaISO);
        return d.toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    };

    const getEstadoClass = (estado) => {
        const map = {
            'Confirmada': 'bg-green-100 text-green-800',
            'Pendiente': 'bg-yellow-100 text-yellow-800',
            'Cancelada': 'bg-red-100 text-red-800'
        };
        return map[estado] || 'bg-gray-100 text-gray-800';
    };
    
    const applyFiltersAndRender = () => {
        let filteredData = [...allReservas];

        // filtro estado
        if (currentStatusFilter !== 'all') {
            filteredData = filteredData.filter(r => r.estado_reserva === currentStatusFilter);
        }

        // filtro texto
        if (currentSearchTerm) {
            const term = currentSearchTerm.toLowerCase();
            filteredData = filteredData.filter(r => 
                r.nombre_cliente.toLowerCase().includes(term) ||
                (r.cedula && r.cedula.toLowerCase().includes(term)) ||
                (r.correo && r.correo.toLowerCase().includes(term))
            );
        }

        // orden
        switch (currentSortOrder) {
            case 'nombre-asc':
                filteredData.sort((a, b) => a.nombre_cliente.localeCompare(b.nombre_cliente));
                break;
            case 'nombre-desc':
                filteredData.sort((a, b) => b.nombre_cliente.localeCompare(a.nombre_cliente));
                break;
            case 'registro-antiguo':
                filteredData.sort((a, b) => new Date(a.fecha_reserva) - new Date(b.fecha_reserva));
                break;
            case 'registro-reciente':
            default:
                filteredData.sort((a, b) => new Date(b.fecha_reserva) - new Date(a.fecha_reserva));
                break;
        }

        renderTable(filteredData);
    };

    const renderTable = (reservas) => {
        tableBody.innerHTML = '';
        if (reservas.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">No se encontraron reservas con los filtros actuales.</td></tr>`;
            summaryLabel.textContent = 'Mostrando 0 resultados.';
            return;
        }

        summaryLabel.textContent = `Mostrando ${reservas.length} de ${allReservas.length} reservas.`;

        reservas.forEach(reserva => {
            const row = `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-900">#${reserva.id_reserva}</td>
                    <td class="px-6 py-4 text-gray-600 font-semibold">${reserva.nombre_cliente}</td>
                    <td class="px-6 py-4 text-gray-600">
                        <div class="font-medium">${reserva.origen_codigo} → ${reserva.destino_codigo}</div>
                        <div class="text-sm text-gray-500">${reserva.nombre_aerolinea}</div>
                    </td>
                    <td class="px-6 py-4 text-gray-600">${formatFecha(reserva.fecha_reserva)}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getEstadoClass(reserva.estado_reserva)}">
                            ${reserva.estado_reserva}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right text-sm font-medium">
                        ${reserva.estado_reserva.toLowerCase() === 'pendiente' ? 
                            `<button class="cancel-btn text-red-600 hover:text-red-900 font-semibold" data-id="${reserva.id_reserva}">Cancelar</button>` 
                            : ''}
                    </td>
                </tr>`;
            tableBody.innerHTML += row;
        });
    };

    const fetchReservas = async () => {
        try {
            const response = await fetch(`http://localhost:3000/reservas/admin/all`); 
            const data = await response.json();
            if (!response.ok) throw new Error('No se pudieron cargar los datos.');
            
            allReservas = data;
            applyFiltersAndRender();
        } catch (error) {
            console.error("Error fetchReservas:", error);
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-500">No se pudo conectar al servidor.</td></tr>`;
        }
    };
    
    // eventos UI filtros/listado
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            currentStatusFilter = button.dataset.scope;

            // marcar pestaña activa visualmente
            filterButtons.forEach(btn => {
                btn.classList.replace('bg-blue-600', 'bg-gray-100');
                btn.classList.replace('text-white', 'text-gray-700');
            });
            button.classList.replace('bg-gray-100', 'bg-blue-600');
            button.classList.replace('text-gray-700', 'text-white');

            applyFiltersAndRender();
        });
    });

    searchInput.addEventListener('input', (e) => {
        currentSearchTerm = e.target.value;
        applyFiltersAndRender();
    });

    orderSelect.addEventListener('change', (e) => {
        currentSortOrder = e.target.value;
        applyFiltersAndRender();
    });

    // cancelar reserva pendiente
    tableBody.addEventListener('click', async (e) => {
        if (e.target.classList.contains('cancel-btn')) {
            const id = e.target.dataset.id;
            if (confirm('¿Estás seguro de que deseas cancelar esta reserva?')) {
                try {
                    const response = await fetch(`http://localhost:3000/reservas/${id}/cancelar`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    alert(`✅ ${result.message}`);
                    fetchReservas();
                } catch (error) {
                    alert(`⚠️ Error al cancelar: ${error.message}`);
                }
            }
        }
    });

    // cargar info inicial
    fetchReservas();

    // ------ sincronizar navbar/footer con sesión y rol admin ------
    (function syncSessionUI() {
        let u = null;
        try {
          const raw = localStorage.getItem("currentUser");
          if (raw) u = JSON.parse(raw);
        } catch (e) {}

        const navMisReservas = document.getElementById("nav-mis-reservas");
        const footerMisReservas = document.getElementById("footer-mis-reservas");
        const loginBtn = document.getElementById("login-button");
        const userMenu = document.getElementById("user-menu");
        const adminPanel = document.getElementById("admin-panel");

        if (u && u.id_usuario) {
          // usuario autenticado
          if (navMisReservas) navMisReservas.classList.remove("hidden");
          if (footerMisReservas) footerMisReservas.classList.remove("hidden");

          if (loginBtn) loginBtn.classList.add("hidden");
          if (userMenu) userMenu.classList.remove("hidden");

          if (adminPanel && u.rol === "Administrador") {
            adminPanel.classList.remove("hidden");
          }
        } else {
          // usuario NO autenticado
          if (navMisReservas) navMisReservas.classList.add("hidden");
          if (footerMisReservas) footerMisReservas.classList.add("hidden");

          if (loginBtn) loginBtn.classList.remove("hidden");
          if (userMenu) userMenu.classList.add("hidden");
        }
    })();
});
</script>

</body>
</html>
